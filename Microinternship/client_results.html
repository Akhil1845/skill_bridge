<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Test Results</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #0a192f;
    color: #e6f1ff;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #64ffda;
  }
  .container {
    max-width: 900px;
    margin: 30px auto;
    background: #112240;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(100, 255, 218, 0.2);
  }
  select {
    width: 100%;
    padding: 10px;
    background: #0a192f;
    border: 1px solid #64ffda;
    color: #e6f1ff;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #233554;
    padding: 10px;
    text-align: center;
  }
  th {
    background-color: #1d2d50;
    color: #64ffda;
  }
  tr:hover {
    background-color: #233554;
  }
  .no-data {
    text-align: center;
    padding: 15px;
    color: #8892b0;
  }
</style>
</head>
<body>

<h1>ðŸ“Š Test Results Dashboard</h1>

<div class="container">
  <h3>Welcome, <span id="clientName">Client</span></h3>

  <label for="testSelect">Select a Test:</label>
  <select id="testSelect">
    <option value="">-- Select Test --</option>
  </select>

  <div id="resultsContainer">
    <table id="resultsTable" style="display:none;">
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Student Name</th>
          <th>Marks</th>
          <th>Max Marks</th>
          <th>Percentage</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
    <div id="noData" class="no-data">Select a test to view results.</div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8081'; // your Spring Boot backend

document.addEventListener('DOMContentLoaded', async () => {
  const loggedClient = JSON.parse(localStorage.getItem('loggedClient'));
  if (!loggedClient) {
    window.location.href = 'login_page.html';
    return;
  }

  document.getElementById('clientName').innerText = loggedClient.name;

  // Fetch tests uploaded by this client
  try {
    const res = await fetch(`${API_BASE}/tests/client/${loggedClient.clientId}`);
    const tests = await res.json();
    const select = document.getElementById('testSelect');
    tests.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.testId;
      opt.text = t.title;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error('Error fetching tests:', err);
  }
});

// When client selects a test, load results
document.getElementById('testSelect').addEventListener('change', async function() {
  const testId = this.value;
  const body = document.getElementById('resultsBody');
  const table = document.getElementById('resultsTable');
  const noData = document.getElementById('noData');
  body.innerHTML = '';

  if (!testId) {
    table.style.display = 'none';
    noData.innerText = 'Select a test to view results.';
    noData.style.display = 'block';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/results/test/${testId}`);
    const results = await res.json();

    if (results.length === 0) {
      table.style.display = 'none';
      noData.innerText = 'No student results found for this test.';
      noData.style.display = 'block';
      return;
    }

    results.forEach(r => {
      const percent = ((r.marks / r.maxMarks) * 100).toFixed(2);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.student.studentId}</td>
        <td>${r.student.name}</td>
        <td>${r.marks}</td>
        <td>${r.maxMarks}</td>
        <td>${percent}%</td>
        <td>${percent >= 40 ? 'Pass' : 'Fail'}</td>
      `;
      body.appendChild(tr);
    });

    table.style.display = 'table';
    noData.style.display = 'none';
  } catch (err) {
    console.error('Error fetching results:', err);
    noData.innerText = 'Error loading results.';
    table.style.display = 'none';
    noData.style.display = 'block';
  }
});
</script>

</body>
</html>
