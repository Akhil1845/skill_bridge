<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Update Profile</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
  * {margin:0; padding:0; box-sizing: border-box;}
  body {
    min-height: 100vh;
    font-family: "Poppins", sans-serif;
    color: white;
    background: linear-gradient(270deg,#cddce5,#5a6084,#4a5d5c,#c4dee9,#535c62);
    background-size: 1200% 1200%;
    animation: bgmove 16s ease infinite;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  @keyframes bgmove {0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  .update-container {
    background: rgba(0,0,0,0.4);
    padding: 30px 25px;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #70baff;
    text-shadow: 0 0 3px #2c67b4;
  }
  label {
    display: block;
    font-size: 0.95rem;
    margin: 10px 0 5px 0;
    color: #e0e0e0;
  }
  input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    background: #2b2d36;
    color: #fff;
    margin-bottom: 10px;
    font-size: 0.95rem;
  }
  .update-btn {
    width: 100%;
    padding: 12px;
    background: #70baff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s;
  }
  .update-btn:hover { background: #3789cb; }
  .back-btn {
    margin-top: 12px;
    display: inline-block;
    text-decoration: none;
    color: #70baff;
    font-weight: 600;
    transition: color 0.3s;
  }
  .back-btn:hover {color: #3789cb;}
</style>
</head>
<body>
<div class="update-container">
  <h2>Update Your Profile</h2>
  <form id="updateProfileForm">
    <label for="name">Name</label>
    <input type="text" id="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" disabled />

    <label for="className">Class</label>
    <input type="text" id="className" />

    <label for="stream">Stream</label>
    <input type="text" id="stream" />

    <label for="program">Program</label>
    <input type="text" id="program" />

    <label for="semester">Semester</label>
    <input type="text" id="semester" />

    <label for="skills">Skills</label>
    <input type="text" id="skills" placeholder="e.g., Java, Python" />

    <label for="phone">Phone</label>
    <input type="text" id="phone" />

    <label for="address">Address</label>
    <input type="text" id="address" />

    <button type="submit" class="update-btn">Save Changes</button>
  </form>
  <a class="back-btn" href="student_dashboard.html">← Back to Dashboard</a>
</div>

<!-- Updated script with config.js -->
<script type="module">
import { CONFIG } from './config.js';

const BASE_URL = `${CONFIG.API_BASE}/students`;
const studentId = localStorage.getItem("studentId");

if(!studentId){
    alert("Please login first!");
    window.location.href = "student_login.html";
}

// Populate form
async function populateForm() {
  try {
    const res = await fetch(`${BASE_URL}/${studentId}`);
    if(!res.ok) throw new Error("Failed to fetch data from server");
    const data = await res.json();
    document.getElementById("name").value = data.name || "";
    document.getElementById("email").value = data.email || "";
    document.getElementById("className").value = data.className || "";
    document.getElementById("stream").value = data.stream || "";
    document.getElementById("program").value = data.program || "";
    document.getElementById("semester").value = data.semester || "";
    document.getElementById("skills").value = data.skills || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("address").value = data.address || "";
  } catch(err) {
    console.warn("Falling back to localStorage", err);
    document.getElementById("name").value = localStorage.getItem("studentName") || "";
    document.getElementById("email").value = localStorage.getItem("studentEmail") || "";
    document.getElementById("className").value = localStorage.getItem("studentClass") || "";
    document.getElementById("stream").value = localStorage.getItem("studentStream") || "";
    document.getElementById("program").value = localStorage.getItem("studentProgram") || "";
    document.getElementById("semester").value = localStorage.getItem("studentSemester") || "";
    document.getElementById("skills").value = localStorage.getItem("studentSkills") || "";
    document.getElementById("phone").value = localStorage.getItem("studentPhone") || "";
    document.getElementById("address").value = localStorage.getItem("studentAddress") || "";
  }
}

// Update profile
document.getElementById("updateProfileForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const updatedData = {
    name: document.getElementById("name").value,
    className: document.getElementById("className").value,
    stream: document.getElementById("stream").value,
    program: document.getElementById("program").value,
    semester: document.getElementById("semester").value,
    skills: document.getElementById("skills").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value
  };

  try {
    const res = await fetch(`${BASE_URL}/${studentId}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(updatedData)
    });
    if(!res.ok) throw new Error("Server error: " + res.status);
    const updated = await res.json();

    // Update localStorage
    Object.entries({
      studentName: updated.name || "",
      studentClass: updated.className || "",
      studentStream: updated.stream || "",
      studentProgram: updated.program || "",
      studentSemester: updated.semester || "",
      studentSkills: updated.skills || "",
      studentPhone: updated.phone || "",
      studentAddress: updated.address || ""
    }).forEach(([k,v]) => localStorage.setItem(k,v));

    alert("✅ Profile updated successfully!");
    window.location.href = "student_dashboard.html";
  } catch(err) {
    console.error(err);
    alert("❌ Error updating profile. Please try again.");
  }
});

window.onload = populateForm;
</script>
</body>
</html>
